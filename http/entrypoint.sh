#!/bin/bash
set -e # Р›СЋР±Р°СЏ РєРѕРјР°РЅРґР°, Р·Р°РІРµСЂС€РёРІС€Р°СЏСЃСЏ СЃ РѕС€РёР±РєРѕР№, РЅРµРјРµРґР»РµРЅРЅРѕ РїСЂРµСЂРІРµС‚ РІС‹РїРѕР»РЅРµРЅРёРµ СЃРєСЂРёРїС‚Р°

# Р¤СѓРЅРєС†РёСЏ РґР»СЏ С‡С‚РµРЅРёСЏ СЃРµРєСЂРµС‚Р° (Docker Secrets РёР»Рё env variable)
get_secret() {
  local name="$1"
  local secret_file="/run/secrets/$name"
  if [ -f "$secret_file" ]; then
    cat "$secret_file"
  else
    printenv "$name" 2>/dev/null || echo ""
  fi
}

# 1. DOMAIN РёР· IMAGE_SERVER_URL (РёР· Docker Secrets РёР»Рё env)
IMAGE_SERVER_URL=$(get_secret "IMAGE_SERVER_URL")
SSL_EMAIL=$(get_secret "SSL_EMAIL")

if [ -z "$IMAGE_SERVER_URL" ]; then
  echo "FATAL: РџРµСЂРµРјРµРЅРЅР°СЏ IMAGE_SERVER_URL РЅРµ Р·Р°РґР°РЅР° (РЅРё РІ Docker Secrets, РЅРё РІ env)."
  exit 1
fi
DOMAIN=$(echo "$IMAGE_SERVER_URL" | sed -E 's~https?://([^/]+)/?.*~\1~')
echo "==> РСЃРїРѕР»СЊР·СѓРµРјС‹Р№ РґРѕРјРµРЅ: $DOMAIN"

# РџСѓС‚Рё Рє СЃРµСЂС‚РёС„РёРєР°С‚Р°Рј
CERT_DIR="/etc/letsencrypt"
LIVE_CERT_DIR="$CERT_DIR/live/$DOMAIN"
CERT_FILE="$LIVE_CERT_DIR/fullchain.pem"
KEY_FILE="$LIVE_CERT_DIR/privkey.pem"

CERTIFICATE_SETUP_SUCCESS=false # Р¤Р»Р°Рі СѓСЃРїРµС€РЅРѕР№ РЅР°СЃС‚СЂРѕР№РєРё SSL СЃ LE СЃРµСЂС‚РёС„РёРєР°С‚РѕРј

# 2. РџРёС€РµРј ServerName РІ РіР»Р°РІРЅС‹Р№ РєРѕРЅС„РёРі Apache
# (РЈР±РµРґРёРјСЃСЏ, С‡С‚Рѕ РЅРµ РґСѓР±Р»РёСЂСѓРµРј Р·Р°РїРёСЃСЊ, РµСЃР»Рё СЃРєСЂРёРїС‚ РїРµСЂРµР·Р°РїСѓСЃРєР°РµС‚СЃСЏ)
if ! grep -q "ServerName $DOMAIN" /etc/apache2/apache2.conf; then
  echo "ServerName $DOMAIN" >> /etc/apache2/apache2.conf
fi

# 3. РћСЃС‚Р°РЅР°РІР»РёРІР°РµРј Apache, РµСЃР»Рё РѕРЅ РІРґСЂСѓРі Р·Р°РїСѓС‰РµРЅ (РґР»СЏ certbot --standalone)
echo "==> РћСЃС‚Р°РЅРѕРІРєР° Apache (РµСЃР»Рё Р·Р°РїСѓС‰РµРЅ)..."
apache2ctl stop || true # РРіРЅРѕСЂРёСЂСѓРµРј РѕС€РёР±РєСѓ, РµСЃР»Рё Apache РЅРµ Р±С‹Р» Р·Р°РїСѓС‰РµРЅ

# 4. РџСЂРѕРІРµСЂСЏРµРј РЅР°Р»РёС‡РёРµ СЃРµСЂС‚РёС„РёРєР°С‚Р° РёР»Рё РїС‹С‚Р°РµРјСЃСЏ РµРіРѕ РїРѕР»СѓС‡РёС‚СЊ
# Р’РђР–РќРћ: Р”РёСЂРµРєС‚РѕСЂРёСЏ /etc/letsencrypt Р”РћР›Р–РќРђ Р±С‹С‚СЊ СЃРјРѕРЅС‚РёСЂРѕРІР°РЅР° РєР°Рє volume,
# С‡С‚РѕР±С‹ СЃРµСЂС‚РёС„РёРєР°С‚С‹ СЃРѕС…СЂР°РЅСЏР»РёСЃСЊ РјРµР¶РґСѓ РїРµСЂРµР·Р°РїСѓСЃРєР°РјРё РєРѕРЅС‚РµР№РЅРµСЂР°!

if [ -f "$CERT_FILE" ] && [ -f "$KEY_FILE" ]; then
    echo "==> РЎРµСЂС‚РёС„РёРєР°С‚ РґР»СЏ $DOMAIN СѓР¶Рµ СЃСѓС‰РµСЃС‚РІСѓРµС‚ ($CERT_FILE)."
    echo "==> РџСЂРѕРІРµСЂРєР° СЃСЂРѕРєР° РґРµР№СЃС‚РІРёСЏ СЃРµСЂС‚РёС„РёРєР°С‚Р°..."
    # РџСЂРѕРІРµСЂСЏРµРј, РЅРµ РёСЃС‚РµРє Р»Рё СЃРµСЂС‚РёС„РёРєР°С‚ (0 СЃРµРєСѓРЅРґ РґРѕ РёСЃС‚РµС‡РµРЅРёСЏ)
    if openssl x509 -checkend 0 -noout -in "$CERT_FILE"; then
        echo "==> РЎСѓС‰РµСЃС‚РІСѓСЋС‰РёР№ СЃРµСЂС‚РёС„РёРєР°С‚ РґРµР№СЃС‚РІРёС‚РµР»РµРЅ."
        CERTIFICATE_SETUP_SUCCESS=true
    else
        echo "==> РЎСЂРѕРє РґРµР№СЃС‚РІРёСЏ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РµРіРѕ СЃРµСЂС‚РёС„РёРєР°С‚Р° РРЎРўР•Рљ РёР»Рё РѕРЅ РїРѕРІСЂРµР¶РґРµРЅ. РўСЂРµР±СѓРµС‚СЃСЏ РЅРѕРІС‹Р№ СЃРµСЂС‚РёС„РёРєР°С‚."
        # CERTIFICATE_SETUP_SUCCESS РѕСЃС‚Р°РµС‚СЃСЏ false, С‚.Рє. РЅРёР¶Рµ Р±СѓРґРµС‚ РїРѕРїС‹С‚РєР° РїРѕР»СѓС‡РёС‚СЊ РЅРѕРІС‹Р№
    fi
else
    echo "==> РЎРµСЂС‚РёС„РёРєР°С‚ РґР»СЏ $DOMAIN РЅРµ РЅР°Р№РґРµРЅ. РўСЂРµР±СѓРµС‚СЃСЏ РЅРѕРІС‹Р№ СЃРµСЂС‚РёС„РёРєР°С‚."
    # CERTIFICATE_SETUP_SUCCESS РѕСЃС‚Р°РµС‚СЃСЏ false
fi

# Р•СЃР»Рё СЃРµСЂС‚РёС„РёРєР°С‚ РЅРµ РЅР°Р№РґРµРЅ, РЅРµРґРµР№СЃС‚РІРёС‚РµР»РµРЅ РёР»Рё С‚СЂРµР±СѓРµС‚ РїРµСЂРІРѕРЅР°С‡Р°Р»СЊРЅРѕРіРѕ РїРѕР»СѓС‡РµРЅРёСЏ
if [ "$CERTIFICATE_SETUP_SUCCESS" = false ]; then
    echo "==> РџРѕРїС‹С‚РєР° РїРѕР»СѓС‡РёС‚СЊ/РѕР±РЅРѕРІРёС‚СЊ СЃРµСЂС‚РёС„РёРєР°С‚ РґР»СЏ $DOMAIN..."
    CERT_ARGS="--standalone -n --agree-tos -d $DOMAIN"
    if [ -n "$SSL_EMAIL" ]; then
        CERT_ARGS="--email $SSL_EMAIL $CERT_ARGS"
    else
        CERT_ARGS="--register-unsafely-without-email $CERT_ARGS"
    fi

    echo "==> Р’С‹РїРѕР»РЅСЏРµС‚СЃСЏ: certbot certonly $CERT_ARGS"

    set +e # Р’СЂРµРјРµРЅРЅРѕ РѕС‚РєР»СЋС‡Р°РµРј РІС‹С…РѕРґ РїРѕ РѕС€РёР±РєРµ РґР»СЏ РІС‹Р·РѕРІР° certbot
    certbot certonly $CERT_ARGS
    CERTBOT_EXIT_CODE=$?
    set -e # Р’РєР»СЋС‡Р°РµРј РѕР±СЂР°С‚РЅРѕ РЅРµРјРµРґР»РµРЅРЅРѕ

    if [ $CERTBOT_EXIT_CODE -eq 0 ]; then
        echo "==> certbot certonly СѓСЃРїРµС€РЅРѕ Р·Р°РІРµСЂС€РµРЅ. РќРѕРІС‹Р№ СЃРµСЂС‚РёС„РёРєР°С‚ РїРѕР»СѓС‡РµРЅ."
        CERTIFICATE_SETUP_SUCCESS=true
    else
        echo "РћРЁРР‘РљРђ: certbot certonly Р·Р°РІРµСЂС€РёР»СЃСЏ СЃ РєРѕРґРѕРј $CERTBOT_EXIT_CODE."
        echo "РџРѕРґСЂРѕР±РЅРѕСЃС‚Рё СЃРјРѕС‚СЂРёС‚Рµ РІ Р»РѕРіРµ /var/log/letsencrypt/letsencrypt.log РІРЅСѓС‚СЂРё РєРѕРЅС‚РµР№РЅРµСЂР°."
        echo "Р’РѕР·РјРѕР¶РЅС‹Рµ РїСЂРёС‡РёРЅС‹: РґРѕСЃС‚РёРіРЅСѓС‚ Р»РёРјРёС‚ Р·Р°РїСЂРѕСЃРѕРІ Let's Encrypt, РїСЂРѕР±Р»РµРјС‹ СЃ DNS/СЃРµС‚СЊСЋ, РёР»Рё РѕС€РёР±РєР° РІ СЃР°РјРѕРј certbot (AttributeError)."
        # CERTIFICATE_SETUP_SUCCESS РѕСЃС‚Р°РµС‚СЃСЏ false
    fi
fi

# 5. Р•СЃР»Рё РЅР°СЃС‚СЂРѕР№РєР° SSL СЃ Let's Encrypt СЃРµСЂС‚РёС„РёРєР°С‚РѕРј РЅРµ СѓРґР°Р»Р°СЃСЊ, РџР Р•РљР РђР©РђР•Рњ Р РђР‘РћРўРЈ
if [ "$CERTIFICATE_SETUP_SUCCESS" = false ]; then
    echo "FATAL: РќРµ СѓРґР°Р»РѕСЃСЊ РїРѕР»СѓС‡РёС‚СЊ РёР»Рё РїРѕРґС‚РІРµСЂРґРёС‚СЊ РІР°Р»РёРґРЅС‹Р№ SSL-СЃРµСЂС‚РёС„РёРєР°С‚ РѕС‚ Let's Encrypt РґР»СЏ РґРѕРјРµРЅР° $DOMAIN."
    echo "РџСЂРёР»РѕР¶РµРЅРёРµ С‚СЂРµР±СѓРµС‚ HTTPS РґР»СЏ РєРѕСЂСЂРµРєС‚РЅРѕР№ СЂР°Р±РѕС‚С‹. Р—Р°РїСѓСЃРє Apache РѕС‚РјРµРЅРµРЅ."
    exit 1 # Р—Р°РІРµСЂС€Р°РµРј СЃРєСЂРёРїС‚ СЃ РѕС€РёР±РєРѕР№. РљРѕРЅС‚РµР№РЅРµСЂ РѕСЃС‚Р°РЅРѕРІРёС‚СЃСЏ.
fi

# --- Р•СЃР»Рё РґРѕС€Р»Рё РґРѕ СЃСЋРґР°, Р·РЅР°С‡РёС‚ CERTIFICATE_SETUP_SUCCESS = true ---

# 6. РќР°СЃС‚СЂР°РёРІР°РµРј Apache SSL, С‚Р°Рє РєР°Рє СЃРµСЂС‚РёС„РёРєР°С‚ СѓСЃРїРµС€РЅРѕ РїРѕР»СѓС‡РµРЅ/СЃСѓС‰РµСЃС‚РІСѓРµС‚ Рё РІР°Р»РёРґРµРЅ
echo "==> РљРѕРЅС„РёРіСѓСЂРёСЂСѓРµРј Apache РґР»СЏ SSL СЃ СЃРµСЂС‚РёС„РёРєР°С‚Р°РјРё Let's Encrypt..."
SSL_CONF_FILE="/etc/apache2/sites-enabled/default-ssl.conf"

if [ ! -f "$SSL_CONF_FILE" ]; then
    echo "FATAL: Р¤Р°Р№Р» РєРѕРЅС„РёРіСѓСЂР°С†РёРё SSL $SSL_CONF_FILE РЅРµ РЅР°Р№РґРµРЅ. РќРµРІРѕР·РјРѕР¶РЅРѕ РЅР°СЃС‚СЂРѕРёС‚СЊ SSL."
    exit 1
fi

# Р—Р°РјРµРЅСЏРµРј РїСѓС‚Рё Рє snakeoil СЃРµСЂС‚РёС„РёРєР°С‚Р°Рј РЅР° РїСѓС‚Рё Рє СЃРµСЂС‚РёС„РёРєР°С‚Р°Рј Let's Encrypt
sed -i "s|SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem|SSLCertificateFile $CERT_FILE|g" "$SSL_CONF_FILE"
sed -i "s|SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key|SSLCertificateKeyFile $KEY_FILE|g" "$SSL_CONF_FILE"
echo "==> РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ Apache SSL РѕР±РЅРѕРІР»РµРЅР° РґР»СЏ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ СЃРµСЂС‚РёС„РёРєР°С‚РѕРІ Let's Encrypt."

# 7. Р’РєР»СЋС‡Р°РµРј РЅРµРѕР±С…РѕРґРёРјС‹Рµ РјРѕРґСѓР»Рё Apache Рё SSL СЃР°Р№С‚
echo "==> Р’РєР»СЋС‡РµРЅРёРµ РјРѕРґСѓР»РµР№ Apache: ssl, headers, rewrite, socache_shmcb..."
a2enmod ssl headers rewrite socache_shmcb || true # РРіРЅРѕСЂРёСЂСѓРµРј РѕС€РёР±РєРё, РµСЃР»Рё РјРѕРґСѓР»Рё СѓР¶Рµ РІРєР»СЋС‡РµРЅС‹

echo "==> Р’РєР»СЋС‡РµРЅРёРµ SSL СЃР°Р№С‚Р° (default-ssl)..."
a2ensite default-ssl 2>/dev/null || true # РРіРЅРѕСЂРёСЂСѓРµРј РѕС€РёР±РєСѓ, РµСЃР»Рё СЃР°Р№С‚ СѓР¶Рµ РІРєР»СЋС‡РµРЅ

# РџРµСЂРµРґ Р·Р°РїСѓСЃРєРѕРј Apache РћР‘РЇР—РђРўР•Р›Р¬РќРћ РїСЂРѕРІРµСЂСЏРµРј РєРѕРЅС„РёРіСѓСЂР°С†РёСЋ
echo "==> РџСЂРѕРІРµСЂРєР° РєРѕРЅС„РёРіСѓСЂР°С†РёРё Apache..."
apache2ctl configtest # Р•СЃР»Рё Р·РґРµСЃСЊ РѕС€РёР±РєР°, СЃРєСЂРёРїС‚ Р·Р°РІРµСЂС€РёС‚СЃСЏ РёР·-Р·Р° 'set -e'

# === Р”РћР‘РђР’Р›Р•РќРќР«Р™ Р‘Р›РћРљ Р”Р›РЇ Р—РђРџРЈРЎРљРђ CRON ===
echo "==> Р—Р°РїСѓСЃРє СЃР»СѓР¶Р±С‹ cron РґР»СЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРіРѕ РѕР±РЅРѕРІР»РµРЅРёСЏ СЃРµСЂС‚РёС„РёРєР°С‚РѕРІ..."
# Р—Р°РїСѓСЃРєР°РµРј cron РІ С„РѕРЅРѕРІРѕРј СЂРµР¶РёРјРµ. РљР»СЋС‡ -f Р·Р°СЃС‚Р°РІР»СЏРµС‚ РµРіРѕ РѕСЃС‚Р°РІР°С‚СЊСЃСЏ РЅР° РїРµСЂРµРґРЅРµРј РїР»Р°РЅРµ,
# РЅРѕ С‚Р°Рє РєР°Рє РјС‹ Р·Р°РїСѓСЃРєР°РµРј РµРіРѕ СЃ '&', РѕРЅ СѓР№РґРµС‚ РІ С„РѕРЅ.
# РђР»СЊС‚РµСЂРЅР°С‚РёРІРЅРѕ, РЅРµРєРѕС‚РѕСЂС‹Рµ СЃРёСЃС‚РµРјС‹ РёСЃРїРѕР»СЊР·СѓСЋС‚ `service cron start`.
# Р”Р»СЏ СЃС‚Р°РЅРґР°СЂС‚РЅРѕРіРѕ Debian-РѕРєСЂСѓР¶РµРЅРёСЏ `cron` Р±РµР· Р°СЂРіСѓРјРµРЅС‚РѕРІ РёР»Рё `cron -f &` РґРѕР»Р¶РЅРѕ СЂР°Р±РѕС‚Р°С‚СЊ.
cron
# Р•СЃР»Рё cron РЅРµ СѓС…РѕРґРёС‚ РІ С„РѕРЅ СЃР°Рј РёР»Рё РІРѕР·РЅРёРєР°СЋС‚ РїСЂРѕР±Р»РµРјС‹, РјРѕР¶РЅРѕ РїРѕРїСЂРѕР±РѕРІР°С‚СЊ:
# (crond -n &) # РґР»СЏ РЅРµРєРѕС‚РѕСЂС‹С… СЃРёСЃС‚РµРј, РіРґРµ cron РґРµРјРѕРЅ РЅР°Р·С‹РІР°РµС‚СЃСЏ crond
# service cron start # РµСЃР»Рё systemV init СЃРєСЂРёРїС‚С‹ РёСЃРїРѕР»СЊР·СѓСЋС‚СЃСЏ
# === РљРћРќР•Р¦ Р”РћР‘РђР’Р›Р•РќРќРћР“Рћ Р‘Р›РћРљРђ ===

echo "==> Р—Р°РїСѓСЃРє Apache СЃ РЅР°СЃС‚СЂРѕРµРЅРЅС‹Рј HTTPS..."
apache2-foreground
